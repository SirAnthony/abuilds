# ABUILD generated by mkpkg_generator.sh

pkgname=nvidia-kernel
pkgver=340.46
pkgbuild=1
arch=('auto')

KERNEL=${KERNEL:-`uname -r`}
KERNPKGVERSION=${KERNEL//-/_}
KERNELPATH=${KERNELPATH:-/lib/modules/${KERNEL}/build}

FINAL_VER=${pkgver}_$(echo $KERNEL | tr - _)
pkgver_orig=$pkgver
pkgver=$FINAL_VER

build_deps="kernel-source"
shortdesc=('nvidia-kernel (Kernel Interface for the nvidia driver)')
longdesc=('This is the kernel module needed by the binary nvidia-driver.')

adddep="kernel==$KERNPKGVERSION"
tags=('drivers proprietary x11-drivers')

TARGET="x86"
if [ "$ARCH" = "x86_64" ] ; then
	TARGET="x86_64"
	gendeps_blacklist='usr/bin/nvidia-settings
	usr/lib\*'
else
	gendeps_blacklist='usr/bin/nvidia-settings'
fi

source=("http://us.download.nvidia.com/XFree86/Linux-${TARGET}/${pkgver_orig}/NVIDIA-Linux-${TARGET}-${pkgver_orig}.run n")

build() {
	set -e
	
	cd $srcdir
	sh $srcache/NVIDIA-Linux-${TARGET}-${pkgver_orig}.run --extract-only
	cd NVIDIA-Linux-${TARGET}-${pkgver_orig}/kernel
	burn_patches
	
	make SYSSRC=$KERNELPATH module || exit 1

	mkdir -p $pkgdir/lib/modules/$KERNEL/kernel/drivers/video
	install -m 0664 nvidia.ko $pkgdir/lib/modules/$KERNEL/kernel/drivers/video/

	mkdir -p ${pkgdir}/install
	sed "s%@KERNEL@%$KERNEL%" $filedir/doinst.sh > $pkgdir/install/doinst.sh


	# This package conflicts with nouveau kernel module, so let's blacklist it:
	mkdir -p ${pkgdir}/etc/modprobe.d
	echo "blacklist nouveau" > ${pkgdir}/etc/modprobe.d/nouveau.conf
	
	set +e

}
