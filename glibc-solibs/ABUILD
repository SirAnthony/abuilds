# ABUILD generated by mkpkg_generator.sh

pkgname=glibc-solibs
pkgver=2.17
pkgbuild=1
arch=("auto")

shortdesc=("GNU C libraries")
tags=("base sys-base compat32")

source=("http://ftp.gnu.org/gnu/glibc/glibc-${pkgver}.tar.xz")

pkglist="i18n"

config_files="etc/nscd.conf"
build_deps="kernel-headers binutils gcc"

custom_opts="no_strip"
i18n() {
	pkgname=glibc-i18n
	shortdesc="GLIBC locales"
	tags=("libs sys-libs")
}

before_build() {
	# glibc uses custom CFLAGS, specify them
	if [ "$ARCH" = "x86_64" ] ; then
		GLIBC_CFLAGS="-O3 -fPIC"
	else
		GLIBC_CFLAGS="-O3 -march=i686"
	fi
}

build() {
	go_src_dir
	burn_patches

	sed -i 's#<rpc/types.h>#"rpc/types.h"#' sunrpc/rpc_clntout.c
	sed -i 's|@BASH@|/bin/bash|' elf/ldd.bash.in

	mkdir glibc_build
	cd glibc_build
	CFLAGS="${GLIBC_CFLAGS}"

	if [[ ${CARCH} = "i686" ]]; then
		# Hack to fix NPTL issues with Xen, only required on 32bit platforms
		export CFLAGS="${CFLAGS} -mno-tls-direct-seg-refs"
	fi

	export CFLAGS



	../configure \
		--prefix=/usr \
		--libdir=/usr/lib${LIBDIRSUFFIX} \
		--enable-kernel=2.6.32 \
		--with-headers=/usr/include \
		--enable-add-ons=libidn,nptl \
		--disable-profile \
		--enable-obsolete-rpc \
		--enable-stackguard-randomization \
		--infodir=/usr/info \
		--mandir=/usr/man \
		--enable-bind-now \
		--disable-multi-arch \
		--with-tls \
		--with-__thread \
		--without-cvs

	make -j${numjobs} || make
	make install install_root=${pkgdir}

	install -m644 $srcdir/glibc-${pkgver}/nscd/nscd.conf ${pkgdir}/etc/nscd.conf

	# Custom stripping
	STRIP_BINARIES="--strip-all"
	STRIP_STATIC="--strip-debug"
	STRIP_SHARED="--strip-unneeded"
	( cd $pkgdir
	strip $STRIP_BINARIES sbin/{ldconfig,sln} \
		usr/bin/{gencat,getconf,getent,iconv,locale,localedef} \
		usr/bin/{makedb,pcprofiledump,pldd,rpcgen,sprof} \
		usr/libexec/getconf/* \
		usr/sbin/{iconvconfig,nscd}
	[[ $ARCH = "x86_64" ]] || strip $STRIP_BINARIES usr/bin/lddlibc4

	strip $STRIP_STATIC usr/lib${LIBDIRSUFFIX}/*.a

	strip $STRIP_SHARED {,usr/}lib${LIBDIRSUFFIX}/{libanl,libBrokenLocale,libcidn,libcrypt}-*.so \
		{,usr/}lib${LIBDIRSUFFIX}/libnss_{compat,db,dns,files,hesiod,nis,nisplus}-*.so \
		{,usr/}lib${LIBDIRSUFFIX}/{libdl,libm,libnsl,libresolv,librt,libutil}-*.so \
		{,usr/}lib${LIBDIRSUFFIX}/{libmemusage,libpcprofile,libSegFault}.so \
		{,usr/}lib${LIBDIRSUFFIX}/{pt_chown,{audit,gconv}/*.so} || true
	)

	make localedata/install-locales install_root=${pkgdir}
}

i18n_prep() {
	mkdir -p ${pkgdir}/usr/lib${LIBDIRSUFFIX}
	mv -f ${p_pkgdir}/usr/lib${LIBDIRSUFFIX}/locale ${pkgdir}/usr/lib${LIBDIRSUFFIX}/
	mv -f ${p_pkgdir}/usr/share/i18n ${pkgdir}/usr/share/
	mv -f ${p_pkgdir}/usr/share/locale ${pkgdir}/usr/share/
}
