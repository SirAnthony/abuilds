# ABUILD generated by mkpkg_generator.sh

pkgname=linux-pam
pkgver=1.1.8
pkgbuild=1
arch=("auto")

unix2_ver=2.9.1

shortdesc=("Pluggable Authentication Modules for Linux")
longdesc=("Pluggable Authentication Modules for Linux")
tags=("base sys-libs")
build_deps="db libtirpc flex docbook-xml docbook-xsl cracklib libaudit"

config_files="etc/security/access.conf
etc/security/group.conf
etc/security/limits.conf
etc/security/namespace.conf
etc/security/namespace.init
etc/security/pam_env.conf
etc/security/time.conf
etc/pam.d/ftp
etc/pam.d/imap
etc/pam.d/kde
etc/pam.d/kde-np
etc/pam.d/netatalk
etc/pam.d/other
etc/pam.d/rexec
etc/pam.d/rlogin
etc/pam.d/rsh
etc/pam.d/squid
etc/pam.d/vlock
etc/pam.d/vmware-authd
etc/pam.d/xdm
etc/pam.d/xlock
etc/environment"
#etc/default/passwd

source=("https://fedorahosted.org/releases/l/i/linux-pam/Linux-PAM-$pkgver.tar.bz2"
        "ftp://ftp.archlinux.org/other/pam_unix2/pam_unix2-${unix2_ver}.tar.bz2")

BUILD_SYSTEM="autotools"
BUILD_KEYS="DESTDIR=$pkgdir --sysconfdir=/etc \
  --enable-sconfigdir=/etc/security \
  --libdir=/lib${LIBDIRSUFFIX} \
  --disable-prelude \
  --docdir=/usr/doc/${pkgname}-${pkgver} \
  --disable-nis"
INSTALL_KEYS="INSTALL=/bin/install DESTDIR=$pkgdir"

after_build() {
  go_src_dir

  # build pam_unix2 module
  ( cd $srcdir/pam_unix2-${unix2_ver}
    ./configure --libdir=/lib${LIBDIRSUFFIX} \
      CFLAGS="$CFLAGS -I$srcdir/Linux-PAM-$pkgver/libpam/include/" \
      LDFLAGS="$LDFLAGS -L$srcdir/Linux-PAM-$pkgver/libpam/.libs/" \
    make -j${numjobs}
    make DESTDIR=$pkgdir install
  )

  # add the realtime permissions for audio users
  sed -i 's|# End of file||' $pkgdir/etc/security/limits.conf
  cat >>$pkgdir/etc/security/limits.conf <<_EOT
*               -       rtprio          0
*               -       nice            0
@audio          -       rtprio          65
@audio          -       nice           -10
@audio          -       memlock         40000
_EOT
  # fix some missing symlinks from old pam for compatibility
  cd $pkgdir/lib${LIBDIRSUFFIX}/security
  ln -s pam_unix.so pam_unix_acct.so
  ln -s pam_unix.so pam_unix_auth.so
  ln -s pam_unix.so pam_unix_passwd.so
  ln -s pam_unix.so pam_unix_session.so
  # set unix_chkpwd uid
  chmod +s $pkgdir/sbin/unix_chkpwd

  # Until this stuff is not in other packages, let it provide from here:
  for i in ${filedir}/pam/* ; do
    install -D $i ${pkgdir}/etc/pam.d/$(basename $i)
  done
}

