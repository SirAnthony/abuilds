# ABUILD generated by mkpkg_generator.sh

pkgname=kbd
pkgver=2.0.1
pkgbuild=1
arch=("auto")

shortdesc=("kbd (keyboard maps and console fonts)")
longdesc=("Load and save keyboard mappings. Needed if you are not using the US keyboard map. This package also contains utilities to change your console fonts - if you install it you'll get a menu later on that lets you select from many different fonts. If you like one, you can make it your default font. A new default font can be chosen at any time by typing 'setconsolefont'.")

tags=("base sys-apps")
build_deps="glibc-solibs check linux-pam"

source=("ftp://ftp.altlinux.org/pub/people/legion/kbd/kbd-${pkgver}.tar.gz"
"http://agilialinux.ru/forked_sources/ru-kbd-maps.txz n")

BUILD_SYSTEM="autotools"
BUILD_KEYS=" --prefix=/usr \
  --localedir=/usr/share/locale/ \
  --mandir=/usr/man \
  --docdir=/usr/doc/$pkgname-$pkgver \
  --datadir=/usr/share/kbd \
  --enable-nls"
INSTALL_KEYS="DESTDIR=${pkgdir}"

before_build() {
  go_src_dir
  ( cd ${pkgdir} ; tar xvf ${filedir}/extraf.tgz )
  ( cd ${pkgdir} ; tar xvf ${srcache}/ru-kbd-maps.txz )
  # This is from Fedora's spec file:
  # 7-bit maps are obsolete; so are non-euro maps
  ( cd data/keymaps/i386
    mv qwerty/fi.map qwerty/fi-old.map
    cp -fav qwerty/fi-latin9.map qwerty/fi.map
    cp -fav qwerty/pt-latin9.map qwerty/pt.map
    cp -fav qwerty/sv-latin1.map qwerty/se-latin1.map
    mv -fv azerty/fr.map azerty/fr-old.map
    cp -fav azerty/fr-latin9.map azerty/fr.map
    cp -fav azerty/fr-latin9.map azerty/fr-latin0.map # legacy alias

    # Rename conflicting keymaps
    mv -fv dvorak/no.map dvorak/no-dvorak.map
    mv -fv fgGIod/trf.map fgGIod/trf-fgGIod.map
    mv -fv olpc/es.map olpc/es-olpc.map
    mv -fv olpc/pt.map olpc/pt-olpc.map
    mv -fv qwerty/cz.map qwerty/cz-qwerty.map 
  )
}

after_build() {
  go_src_dir

  # This is where it's always been in Slackware, so let's move it back:
  ( cd ${pkgdir}
    mkdir -vpm755 bin
    mv -fv usr/bin/loadkeys bin/
    cd usr/bin ; ln -vsf ../../bin/loadkeys . 
  )

  # ro_win.map.gz is useless
  rm -fv ${pkgdir}/usr/share/kbd/keymaps/i386/qwerty/ro_win.map.gz

  # The rhpl keyboard layout table is indexed by kbd layout names, so we need a
  # Korean keyboard
  ln -vfs us.map.gz ${pkgdir}/usr/share/kbd/keymaps/i386/qwerty/ko.map.gz


  # Additional keymaps:
  # This is the keymap for Speakup (http://linux-speakup.org) users:
  cat $filedir/speakupmap.map.gz > ${pkgdir}/usr/share/kbd/keymaps/i386/qwerty/speakupmap.map.gz
  # Another keymap for Speakup from Thomas Ward, for JFW users.
  tar xvf $filedir/speakup-jfw.tar.gz
  ( cd speakup-jfw
    cat speakup-jfw.map | gzip -9c > ${pkgdir}/usr/share/kbd/keymaps/i386/qwerty/speakup-jfw.map.gz
    cat readme > ${pkgdir}/usr/share/kbd/keymaps/i386/qwerty/speakup-jfw.readme 
  )
}

